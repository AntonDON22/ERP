# Система Тестирования Валидации

## Обзор

Модуль тестирования валидации предназначен для обеспечения консистентности и корректности схем валидации в ERP системе. Тесты покрывают все критические области валидации данных.

## Структура

```
tests/validation/
├── README.md                    # Документация
└── schema-validation.test.ts    # Основные тесты валидации
```

## Назначение тестов

### 1. zFields.ts Coverage Tests
Проверяют корректную работу всех универсальных полей валидации:
- `zId` - валидация ID (положительные целые числа)
- `zPrice` - валидация цен (неотрицательные числа)
- `zQuantity` - валидация количества (неотрицательные числа)
- `zQuantityInteger` - валидация целых количеств
- Строковые варианты (`zPriceString`, `zQuantityString` и др.)

### 2. Manual Validation Problems Identification
Выявляют проблемные места с ручной валидацией в:
- `shared/schema.ts` - основные схемы системы
- `server/middleware/validation.ts` - middleware валидации

**Найденные проблемы:**
- Ручная валидация `warehouseId` в документах (строка 166-169)
- Ручная валидация `name` в receiptDocumentSchema (строка 245)
- Множественные ручные валидации в схемах заказов (строки 280-297)
- Ручная валидация `status` в orderSchema (строка 343)
- Все схемы в middleware/validation.ts (idParamSchema, *IdsSchema)

### 3. Middleware Validation Problems Identification
Тестируют проблемы в middleware валидации:
- `idParamSchema` - должен использовать `zId`
- Массивы ID (*IdsSchema) - должны использовать `z.array(zId)`

### 4. Comprehensive Schema Consistency Tests
Проверяют единообразие валидации:
- Все ID используют одинаковые правила
- Все цены используют одинаковые правила
- Все количества используют одинаковые правила

### 5. Migration Readiness Tests
Проверяют готовность к миграции:
- Все типы валидации покрыты zFields.ts
- Русские сообщения об ошибках единообразны

## Запуск тестов

```bash
# Запуск всех тестов валидации
npm test tests/validation/

# Запуск конкретного файла
npm test tests/validation/schema-validation.test.ts

# Запуск с детальным выводом
npm test tests/validation/ -- --reporter=verbose
```

## Найденные проблемы

### Критические места для миграции:

1. **shared/schema.ts**:
   - Строка 166-169: `warehouseId` в `insertDocumentSchema`
   - Строка 245: `name` в `receiptDocumentSchema`
   - Строки 280-284: `name` в `createOrderSchema`
   - Строки 291-294: `notes` в `createOrderSchema`
   - Строки 295-297: `date` в `createOrderSchema`
   - Строки 306-310: `name` в `insertOrderSchema`
   - Строка 343: `status` в `orderSchema`

2. **server/middleware/validation.ts**:
   - Строки 91-96: `idParamSchema`
   - Строки 103-147: Все схемы `*IdsSchema`

### Все проблемные места помечены комментариями:
```typescript
// Внимание: поле валидируется вручную. Рекомендуется использовать соответствующее поле из zFields.ts для унификации
```

## Архитектурные рекомендации

### Пример миграции:

**До (проблема):**
```typescript
warehouseId: z.number()
  .positive("ID склада должен быть положительным числом")
  .int("ID склада должен быть целым числом")
  .optional(),
```

**После (решение):**
```typescript
warehouseId: zId.optional(),
```

### Преимущества унификации:
1. **Консистентность** - одинаковая валидация во всех местах
2. **Читаемость** - краткие и понятные схемы
3. **Поддержка** - изменения в одном месте (zFields.ts)
4. **Локализация** - единообразные русские сообщения

## Интеграция в CI/CD

Тесты валидации должны запускаться:
- При каждом коммите
- Перед развертыванием
- При изменении схем валидации

## Метрики покрытия

Текущее покрытие проблемных мест:
- **shared/schema.ts**: 7 найденных проблем
- **server/middleware/validation.ts**: 7 найденных проблем
- **Всего проблемных схем**: 14
- **Схем с комментариями**: 14 (100%)

## Будущие улучшения

1. Автоматическая миграция схем
2. Линтер для обнаружения ручной валидации
3. Автогенерация тестов для новых схем
4. Интеграция с performance тестами