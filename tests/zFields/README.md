# Тесты централизованной валидации zFields.ts

## Обзор

Этот модуль тестирования обеспечивает полное покрытие централизованной системы валидации `shared/zFields.ts`. Система валидации - критически важная часть архитектуры приложения, обеспечивающая консистентность и безопасность данных.

## Архитектурные принципы

### Централизованная валидация
- **Все числовые поля** должны использовать схемы из `zFields.ts`
- **Запрещено** создавать кастомные правила валидации для типовых полей
- **Обязательно** использовать готовые поля: `zPrice`, `zQuantity`, `zId`, `zPercent` и др.

### Типы полей
- **zPrice** - ценовые поля (≥0, число)
- **zPriceString** - цены для БД (строка)
- **zQuantity** - количества (>0, дробные разрешены)
- **zQuantityInteger** - целые количества (>0, только целые)
- **zQuantityString** - количества для БД (строка)
- **zId** - идентификаторы (>0, только целые)
- **zPercent** - проценты (0-100)
- **zWeight** - вес (≥0)

## Структура тестов

### zFieldsValidation.test.ts
- **164 теста** покрывают все поля и граничные случаи
- **Валидные входы** - проверка корректной обработки
- **Невалидные входы** - проверка отклонения неправильных данных
- **Типы данных** - проверка преобразования строк в числа
- **Граничные случаи** - edge cases и экстремальные значения
- **Русскоязычные ошибки** - проверка локализации сообщений

## Запуск тестов

```bash
# Запуск всех тестов валидации
npm test -- tests/zFields/

# Запуск с детальным выводом
npm test -- tests/zFields/ --reporter=verbose

# Запуск в watch-режиме для разработки
npm test -- tests/zFields/ --watch
```

## Результаты тестирования

При правильной реализации все 164 теста должны проходить успешно:

```
✓ zPrice - Ценовые поля (12 тестов)
✓ zPriceString - Ценовые поля для БД (6 тестов)
✓ zQuantity - Количественные поля (10 тестов)
✓ zQuantityInteger - Целые количества (12 тестов)
✓ zQuantityString - Количества для БД (8 тестов)
✓ zId - Идентификаторы (12 тестов)
✓ zPercent - Процентные значения (10 тестов)
✓ zWeight - Вес товаров (8 тестов)
✓ Общие тесты валидации (48 тестов)
✓ Граничные случаи и edge cases (38 тестов)
```

## Важные проверки

### 1. Преобразование типов
- Строки корректно преобразуются в числа
- Числа корректно преобразуются в строки (для БД)
- Пустые строки и пробелы отклоняются

### 2. Валидация диапазонов
- Отрицательные значения отклоняются (кроме весов ≥0)
- Нулевые значения правильно обрабатываются
- Максимальные значения не превышают лимиты

### 3. Русскоязычные ошибки
- Все сообщения об ошибках на русском языке
- Понятные формулировки для пользователей
- Консистентность стиля сообщений

## Интеграция с архитектурой

### Проблемные места (требуют исправления)
1. `client/src/components/Document.tsx` - кастомные схемы валидации
2. `shared/schema.ts` - некоторые схемы не используют zFields
3. Новые компоненты могут создавать дублирующую валидацию

### Правильная интеграция
```typescript
// ❌ Неправильно - кастомная валидация
const schema = z.object({
  price: z.number().min(0, "Цена не может быть отрицательной"),
  quantity: z.number().min(1, "Количество должно быть больше 0")
});

// ✅ Правильно - централизованная валидация
import { zPrice, zQuantity } from '@shared/zFields';

const schema = z.object({
  price: zPrice,
  quantity: zQuantity
});
```

## Поддержка и развитие

При добавлении новых типов полей:

1. **Добавить поле** в `shared/zFields.ts`
2. **Создать тесты** в этом файле
3. **Обновить документацию** README
4. **Мигрировать** существующие схемы
5. **Проверить** отсутствие регрессий

## Связанные файлы

- `shared/zFields.ts` - основные схемы валидации
- `shared/SCHEMA_GUIDE.md` - архитектурные правила
- `tests/utils/zFields.test.ts` - дополнительные unit-тесты
- `shared/schema.ts` - схемы таблиц БД (должны использовать zFields)

## Метрики качества

- **Покрытие кода**: 100% всех функций zFields.ts
- **Граничные случаи**: 38 специализированных тестов
- **Типизация**: Проверка всех возможных комбинаций входных типов
- **Локализация**: Проверка русскоязычных сообщений во всех полях