Техническое задание: Реализация складского FIFO-учёта с возможностью списания в минус (по принципу «Мой Склад») — упрощённая модель без связей между партиями

Цель:
Разработать модуль складского учёта в ERP+CRM-системе, реализующий списание товаров по методу FIFO (первым пришёл — первым выбыл), с возможностью оформления движений в минус. Учёт ведётся на уровне записей движений, остатки рассчитываются по сумме всех записей без ручного связывания партий между собой.

⸻

Структура данных:

В системе создаётся таблица, которая хранит все движения товаров по складу. Каждое движение — это отдельная запись: либо приход (положительное количество), либо расход (отрицательное количество). Отдельной таблицы для остатков или связей между поступлениями и списаниями не требуется.

В таблице хранятся следующие поля:
	•	Уникальный идентификатор записи.
	•	Идентификатор товара.
	•	Количество, положительное для приходов и отрицательное для списаний.
	•	Закупочная цена (используется только при приходе).
	•	Тип движения: приход (IN) или расход (OUT).
	•	Ссылка на документ (например, заказ или накладная).
	•	Дата и время создания записи.

Дополнительно на уровне базы создаются индексы по товару и дате создания записи, чтобы ускорить выборки при списаниях по FIFO.

⸻

Логика работы:

1. Приход товара:
Когда оформляется приход, создаётся запись о приходе с положительным количеством, закупочной ценой и датой поступления. Дальнейших действий не требуется. Система не проверяет наличие минуса и не делает автоматического покрытия.

2. Списание товара:
При оформлении списания система выбирает ранее поступившие партии товара в порядке увеличения даты (то есть самые старые). Если доступного количества в этих партиях достаточно — списание происходит полностью. Если нет — оставшееся количество оформляется одной записью со знаком минус, чтобы учесть нехватку на складе. Таким образом, товар может быть продан в минус.

3. Остатки на складе:
Остаток по товару рассчитывается как сумма всех количеств по данному товару в таблице движений. Если сумма положительная — товар есть в наличии. Если отрицательная — была продажа в минус, и товар нужно заказать или оприходовать.

⸻

API, которые нужно реализовать:

Первый — это добавление прихода. Он получает от клиента данные о товаре, количестве, закупочной цене и документе, и записывает новое движение прихода.

Второй — это списание. Система получает данные о товаре и количестве, и списывает указанное количество в соответствии с FIFO. Если остатков недостаточно, создаётся запись с отрицательным количеством.

⸻

Правила системы:
	•	Все записи о движениях являются неизменяемыми. Если требуется корректировка, она оформляется отдельным движением с противоположным значением количества.
	•	Связи между партиями прихода и расхода не ведутся. FIFO реализуется логикой выборки в коде.
	•	Себестоимость рассчитывается при необходимости отдельно — например, по последней цене закупки или с использованием периодического перерасчёта.
	•	Списание в минус разрешено, остатки могут быть отрицательными.