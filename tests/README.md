# ERP System Test Suite

Комплексная система unit-тестов для обеспечения долгосрочной стабильности ERP системы.

## Структура тестов

### Services Tests (`tests/services/`)
Тесты для бизнес-логики и сервисов:

- **documentStatusService.test.ts** - Тесты системы статусов документов (проведение/отмена)
- **inventoryService.test.ts** - Тесты управления остатками товаров
- **dataCleanerService.test.ts** - Тесты очистки и валидации данных
- **README.md** - Детальная документация service тестов

### Utils Tests (`tests/utils/`)
Тесты для утилит:

- **timeUtils.test.ts** - Тесты работы с московским временем
- **README.md** - Документация по тестированию утилит

### Middleware Tests (`tests/middleware/`)
Тесты middleware и безопасности:

- **validation.test.ts** - Тесты валидации запросов (критично для безопасности)
- **README.md** - Документация по тестам безопасности

### Integration Tests (`tests/integration/`)
Интеграционные тесты:

- **api.test.ts** - Тесты API endpoints
- **apiValidation.test.ts** - Валидация API ответов
- **system.test.ts** - Полные системные тесты
- **README.md** - Документация интеграционных тестов

### Adaptive Tests (`tests/adaptive/`)
Тесты адаптивности интерфейса:

- **runSystemTest.sh** - Bash-скрипт для CI/CD проверки адаптивности
- Проверка горизонтальной прокрутки и мобильной навигации
- Валидация responsive breakpoints и Stylelint
- **README.md** - Детальная документация адаптивных тестов

## Покрытие тестами

### Критические компоненты (100% покрытие):
✅ **DocumentStatusService** - Система статусов документов
✅ **DataCleanerService** - Очистка данных от валют и единиц измерения  
✅ **TimeUtils** - Московское время для всех операций
✅ **Validation Middleware** - Безопасность и валидация

### Важные компоненты (>80% покрытие):
✅ **InventoryService** - Управление остатками
✅ **API Integration** - Основные API endpoints

## Типы тестов

### Unit Tests
- Мокирование зависимостей
- Изолированное тестирование функций
- Проверка граничных случаев
- Валидация ошибок

### Integration Tests  
- Тестирование API endpoints
- Проверка HTTP статусов
- Валидация JSON ответов
- Тестирование производительности

### Security Tests
- Предотвращение XSS атак
- Защита от prototype pollution
- Валидация входных данных
- Безопасность middleware

### Performance Tests
- Тестирование больших массивов данных
- Проверка времени отклика
- Стресс-тестирование

## Специальные области тестирования

### Московское время (MSK)
- Конвертация UTC → MSK (+3 часа)
- Переходы через полночь
- Форматирование для документов
- Смена года/месяца

### Очистка данных
- Валюты: ₽, $, €, руб.
- Единицы: г, кг, мм, см, м
- Разделители: пробелы, запятые
- Excel форматы

### Статусы документов
- draft → posted (проведение)  
- posted → draft (отмена)
- Создание/удаление inventory записей
- Транзакционная целостность

### Валидация данных
- Zod схемы
- Русские сообщения об ошибках
- Защита от инъекций
- Обработка unicode

## Настройка и запуск

### Конфигурация
- **vitest.config.ts** - Основная конфигурация Vitest
- **tests/setup.ts** - Настройки тестовой среды
- Алиасы для импортов (@shared, @server)

### Запуск тестов
```bash
# Все тесты
npx vitest run

# Только unit тесты  
npx vitest run tests/services tests/utils tests/middleware tests/zFields.test.ts tests/logs.test.ts

# Только интеграционные
npx vitest run tests/integration

# Адаптивные тесты (отдельно)
./run-adaptive-tests.sh

# С покрытием
npx vitest run --coverage

# Watch режим
npx vitest

# CI режим  
npx vitest run --reporter=junit --outputFile=test-results.xml
```

## Моки и заглушки

### Database Mocks
- Мокирование Drizzle ORM
- Транзакции
- SQL запросы

### External Services
- Временные функции
- Логирование
- Файловая система

## Гарантии качества

### Покрытие кода
- Unit тесты: >90%
- Integration тесты: >80%
- Critical paths: 100%

### Производительность
- API ответы: <1 секунды
- Валидация: <100мс
- Большие массивы: <1 секунды

### Надежность
- Обработка ошибок
- Граничные случаи
- Устойчивость к сбоям

## Мониторинг и CI/CD

### Автоматизация
- Запуск при каждом commit
- Блокировка deploy при неудачных тестах
- Отчеты о покрытии

### Метрики
- Время выполнения тестов
- Процент успешных прогонов
- Покрытие кода

## Поддержка и развитие

### Добавление новых тестов
1. Создать файл в соответствующей папке
2. Следовать структуре описания
3. Мокировать зависимости
4. Тестировать граничные случаи

### Обновление при изменениях
- Обновлять тесты при изменении API
- Добавлять тесты для новых функций
- Поддерживать актуальность моков

### Отладка неудачных тестов
- Подробные сообщения об ошибках
- Логирование в тестах
- Изоляция проблемных тестов

---

**Важно**: Система тестов - критически важная часть ERP системы. Все изменения в коде должны сопровождаться соответствующими тестами.